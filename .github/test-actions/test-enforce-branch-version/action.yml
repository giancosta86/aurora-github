name: Test enforce-branch-version

runs:
  using: composite
  steps:
    - shell: bash
      run: echo "游꿠Testing 'skip' mode..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: skip
        project-directory: tests/rust-crate

    - shell: bash
      run: echo "游꿠Testing 'inject' mode for 游닍NodeJS package..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: inject
        project-directory: tests/npm-package

    - shell: bash
      run: echo "游꿠Testing 'inject' mode for 游Rust crate..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: inject
        project-directory: tests/rust-crate

    - shell: bash
      run: echo "游꿠Testing 'inject' mode for 游Rust 游깷WebAssembly..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: inject
        project-directory: tests/rust-wasm

    - shell: bash
      run: echo "游꿠Testing 'inject' mode for 游뿼Maven project..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: inject
        project-directory: tests/maven-project

    - shell: bash
      run: echo "游꿠Testing 'inject' mode for 游냊Gradle project..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: inject
        project-directory: tests/gradle-project

    - shell: bash
      run: echo "游꿠Testing 'inject' mode for 游냀Python library..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: inject
        project-directory: tests/python-lib

    - shell: bash
      run: echo "游꿠Testing 'inject' mode for 游꾸unknown tech stack..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: inject
        artifact-descriptor: some-descriptor.txt
        project-directory: tests/unknown-tech

    - shell: bash
      run: echo "游꿠Testing 'check' mode for 游닍NodeJS package..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: check
        project-directory: tests/npm-package

    - shell: bash
      run: echo "游꿠Testing 'check' mode for 游Rust crate..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: check
        project-directory: tests/rust-crate

    - shell: bash
      run: echo "游꿠Testing 'check' mode for 游Rust 游깷WebAssembly..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: check
        project-directory: tests/rust-wasm

    - shell: bash
      run: echo "游꿠Testing 'check' mode for 游뿼Maven project..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: check
        project-directory: tests/maven-project

    - shell: bash
      run: echo "游꿠Testing 'check' mode for 游냊Gradle project..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: check
        project-directory: tests/gradle-project

    - shell: bash
      run: echo "游꿠Testing 'check' mode for 游냀Python library..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: check
        project-directory: tests/python-lib

    - shell: bash
      run: echo "游꿠Testing 'check' mode for 游꾸unknown tech stack..."

    - name: Check version for unknown tech
      uses: ./actions/enforce-branch-version
      with:
        mode: check
        artifact-descriptor: some-descriptor.txt
        project-directory: tests/unknown-tech

    - shell: bash
      run: echo "游꿠Now testing the NodeJS package scenario, passing an explicit descriptor..."

    - uses: ./actions/enforce-branch-version
      with:
        mode: check
        artifact-descriptor: package.json
        project-directory: tests/npm-package

    - uses: ./actions/detect-branch-version
      id: version-detector

    - shell: bash
      run: echo "游꿠Verifying that the version has been injected multiple times..."

    - shell: bash
      working-directory: tests/unknown-tech
      run: |
        version="${{ steps.version-detector.outputs.version }}"

        if grep "A: v$version" some-descriptor.txt && grep "B: '$version'" some-descriptor.txt
        then
          echo "九The version was injected multiple times into the 游꾸unknown tech descriptor!"
        else
          echo "仇The version was not injected multiple times into the 游꾸unknown tech descriptor!" >&2
          exit 1
        fi
