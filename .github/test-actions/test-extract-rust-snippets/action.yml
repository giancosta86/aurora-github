name: Test extract-rust-snippets

runs:
  using: composite
  steps:
    - shell: bash
      run: echo "ğŸ­Trying to generate test files from Markdown file without snippets..."

    - uses: ./actions/extract-rust-snippets
      with:
        project-directory: tests/unknown-tech
        markdown-file: NO-SNIPPETS.md
        test-filename-prefix: fake-tests/fake-

    - name: The Rust test files should not have been created
      shell: bash
      working-directory: tests/unknown-tech/fake-tests
      run: |
        echo "ğŸ”Inspecting the 'fake-tests' subdirectory..."
        ls -1 2>/dev/null
        echo "ğŸ”ğŸ”ğŸ”"

        files="$(ls -1 2>/dev/null)"

        if [[ -z "$files" ]]
        then
          echo "âœ…No generated test files, as expected"
        else
          echo "âŒThere should be no generated test files!" >&2
          exit 1
        fi

    - shell: bash
      run: echo "ğŸ­Generating test files from Markdown file with snippets..."

    - name:
      uses: ./actions/extract-rust-snippets
      with:
        project-directory: tests/unknown-tech

    - name: The Rust test files should have been created
      shell: bash
      working-directory: tests/unknown-tech/tests
      run: |
        echo "ğŸ”Inspecting the 'tests' subdirectory..."
        ls -1 2>/dev/null
        echo "ğŸ”ğŸ”ğŸ”"

        echo "ğŸ”Now ensuring all the 3 test files exist..."

        for i in {1..3}
        do
          testFile="readme_test_${i}.rs"
          if [[ ! -f "$testFile" ]]
          then
            echo "âŒMissing Rust test file: '$testFile'"
            exit 1
          fi
        done

        echo "âœ…All the test files exist!"

    - name: The first test must contain the expected Rust source code
      shell: bash
      working-directory: tests/unknown-tech/tests
      run: |
        testFile="readme_test_1.rs"

        echo "ğŸ”Inspecting the content of the first test file..."
        cat $testFile
        echo "ğŸ”ğŸ”ğŸ”"

        grep -q 'Alpha' "$testFile"
        grep -q 'Beta' "$testFile"
        grep -q 'main().unwrap();' "$testFile"
        echo "âœ…First test file OK!"

    - name: The second test must contain the expected Rust source code
      shell: bash
      working-directory: tests/unknown-tech/tests
      run: |
        testFile="readme_test_2.rs"

        echo "ğŸ”Inspecting the content of the second test file..."
        cat $testFile
        echo "ğŸ”ğŸ”ğŸ”"

        grep -q 'Gamma' "$testFile"
        grep -q 'Delta' "$testFile"
        grep -q 'Epsilon' "$testFile"
        grep -q 'main().unwrap();' "$testFile"
        echo "âœ…Second test file OK!"

    - name: The third test must contain the expected Rust source code
      shell: bash
      working-directory: tests/unknown-tech/tests
      run: |
        testFile="readme_test_3.rs"

        echo "ğŸ”Inspecting the content of the third test file..."
        cat $testFile
        echo "ğŸ”ğŸ”ğŸ”"

        grep -q 'Sigma' "$testFile"
        grep -q 'Tau' "$testFile"
        grep -q 'main().unwrap();' "$testFile"
        echo "âœ…Third test file OK!"

    - shell: bash
      run: echo "ğŸ­Trying to generate test files from inexisting Markdown file..."

    - uses: ./actions/extract-rust-snippets
      with:
        project-directory: tests/unknown-tech
        markdown-file: JUST_INEXISTING_MARKDOWN.md
        optional: true
        test-filename-prefix: fake-tests/fake-
