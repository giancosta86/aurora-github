name: Test setup-nodejs-context

runs:
  using: composite
  steps:
    - name: Setup environment variables
      shell: bash
      working-directory: tests/npm-package
      run: |
        expectedNodeVersion="$(jq -r '.engines.node' package.json)"
        echo "ðŸ”ŽExpected NodeJS version: '$expectedNodeVersion'"

        expectedPnpmVersion="$(jq -r '.packageManager' package.json | sed s/^pnpm@//)"
        echo "ðŸ”ŽExpected pnpm version: '$expectedPnpmVersion'"

        echo "expectedNodeVersion=$expectedNodeVersion" >> $GITHUB_ENV
        echo "expectedPnpmVersion=$expectedPnpmVersion" >> $GITHUB_ENV
        echo "dependenciesDirectory=node_modules" >> $GITHUB_ENV

    - name: The expected NodeJS version should not be pre-installed
      shell: bash
      working-directory: tests/npm-package
      run: |
        if type node &> /dev/null
        then
          installedNodeVersion="$(node --version | sed s/^v//)"
          echo "ðŸ”ŽPre-installed NodeJS version: '$installedNodeVersion'"

          if [[ "$installedNodeVersion" == "$expectedNodeVersion" ]]
          then
            echo "âŒThe expected NodeJS version is pre-installed!" >&2
            exit 1
          fi
        else
          echo "ðŸ’­NodeJS not preinstalled..."
        fi

    - name: The expected pnpm version should not be pre-installed
      shell: bash
      working-directory: tests/npm-package
      run: |
        if type pnpm &> /dev/null
        then
          installedPnpmVersion="$(pnpm --version)"
          echo "ðŸ”ŽPre-installed pnpm version: '$installedPnpmVersion'"

          if [[ "$installedPnpmVersion" == "$expectedPnpmVersion" ]]
          then
            echo "âŒThe expected pnpm version is pre-installed!" >&2
            exit 1
          fi
        else
          echo "ðŸ’­pnpm not preinstalled..."
        fi

    - name: Ensure the dependencies are not installed
      shell: bash
      working-directory: tests/npm-package
      run: rm -rf "$dependenciesDirectory"

    - name: Setup the NodeJS context
      uses: ./actions/setup-nodejs-context
      with:
        project-directory: tests/npm-package

    - name: The expected NodeJS version should be used
      shell: bash
      working-directory: tests/npm-package
      run: |
        installedNodeVersion="$(node --version | sed s/^v//)"
        echo "ðŸ”ŽInstalled NodeJS version: '$installedNodeVersion'"

        if [[ "$installedNodeVersion" == "$expectedNodeVersion" ]]
        then
          echo "âœ…The requested NodeJS version is being used!"
        else
          echo "âŒThe requested NodeJS version is not running!" >&2
          exit 1
        fi

    - name: The expected pnpm version should be used
      shell: bash
      working-directory: tests/npm-package
      run: |
        installedPnpmVersion="$(pnpm --version)"
        echo "ðŸ”ŽInstalled pnpm version: '$installedPnpmVersion'"

        if [[ "$installedPnpmVersion" == "$expectedPnpmVersion" ]]
        then
          echo "âœ…The expected pnpm version is being used!"
        else
          echo "âŒThe expected pnpm version is not running!" >&2
          exit 1
        fi

    - name: The dependencies should have been installed
      shell: bash
      working-directory: tests/npm-package
      run: |
        if [[ -d "$dependenciesDirectory" ]]
        then
          echo "âœ…The dependencies have been installed!"
        else
          echo "âŒThe dependencies have not been installed!" >&2
          exit 1
        fi
