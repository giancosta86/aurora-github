name: "Publish NPM package"
description: "Publish a package to NPM"

inputs:
  project-dir:
    description: "Directory containing the package.json"
    required: false
    default: "."

  pnpm-version:
    description: "Specific version of pnpm to use"
    required: false
    default: 9

runs:
  using: "composite"
  steps:
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ inputs.pnpm-version }}

    - name: Setup NodeJS and NPM registry
      uses: actions/setup-node@v4
      with:
        node-version-file: ".nvmrc"
        registry-url: "https://registry.npmjs.org"
        cache: "pnpm"

    - name: Install dependencies
      working-directory: ${{ inputs.project-directory }}
      run: pnpm install --frozen-lockfile

    - name: Run prepack-based deployment pipeline
      working-directory: ${{ inputs.project-directory }}
      run: pnpm publish --no-git-checks --access public

      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
